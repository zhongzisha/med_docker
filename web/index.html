<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- CSS stylesheet -->
    <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="annotorious-openseadragon/dist/annotorious.min.css">
    <style>
        .patchzoom {
            padding: 1px;
            /*background-color: green;*/
            transition: transform .2s; /* Animation */
            /*width: 200px;*/
            /*height: 200px;*/
            margin: 0 auto;
        }

        .patchzoom:hover {
            transform: scale(1.5); /* (150% zoom - Note: if the zoom is too large, it will go outside of the viewport) */
        }

        table {
            border-collapse: collapse;
            border: 1px solid #FF0000;
            text-align: center;
        }

        table td {
            border: 1px solid #FF0000;
            vertical-align: middle;
            horiz-align: center;
        }

        .seadragon-viewer {
            display: inline-block;
            width: 24%;
            height: 300px;
        }

        .seadragon-viewer4 {
            display: inline-block;
            width: 24%;
            height: 300px;
            overflow: scroll;
        }

        .box {
            display: inline-block;
            height: 20px;
            width: 20px;
            border: 2px solid;
        }

        .img1 {
            /*display: inline;*/
            height: 48px;
            width: 48px;
            float: left;
            padding: 1px;
            margin: 0 auto;
            cursor: pointer;
        }
        /*.img1:hover {*/
        /*    transform: scale(2.0); !* (150% zoom - Note: if the zoom is too large, it will go outside of the viewport) *!*/
        /*}*/

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 12px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            animation: fadeEffect 1s;
        }

        /* Go from zero to full opacity */
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
    </style>
</head>
<body>
<!-- JS -->
<script type="text/javascript" src='openseadragon/build/openseadragon/openseadragon.js'></script>
<script type="text/javascript" src='jquery/dist/jquery.min.js'></script>
<script type="text/javascript" src="annotorious-openseadragon/dist/openseadragon-annotorious.min.js"></script>
<script defer="defer"
        src="recogito-client-plugins/plugins/annotorious-shape-labels/dist/annotorious-shape-labels.min.js"></script>
<!--<script src="mycolors.js"></script>-->
<script src="/mycolors.js?ver=123" type="text/javascript"></script>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.153.0/examples/jsm/"
    }
  }
</script>

<div class="column">
    <div style="margin: 1px; padding: 1px; border: 1px; background-color: Wheat">
        <label for="project_type" style="color:red">Project: </label>
        <select name="project_type" id="project_type">
<!--            <option value="TCGA-BRCA" selected>TCGA-BRCA</option>-->
<!--            <option value="METABRIC_SurvivalGroups-LumA" selected>METABRIC-LumA</option>-->
<!--            <option value="METABRIC_SurvivalGroups-LumB">METABRIC-LumB</option>-->
<!--            <option value="METABRIC_SurvivalGroups-Basal">METABRIC-Basal</option>-->
<!--            <option value="METABRIC_SurvivalGroups-Her2">METABRIC-Her2</option>-->
<!--            <option value="METABRIC_SurvivalGroups-claudin-low">METABRIC-claudin-low</option>-->
<!--            <option value="METABRIC_SurvivalGroups-Normal">METABRIC-Normal</option>-->
<!--            <option value="TransNEO_train-ResponseGroups-T-FEC">TransNEO-T-FEC</option>-->
<!--            <option value="TransNEO_train-ResponseGroups-FEC-T+Trastuzumab">TransNEO-FEC-T+Trastuzumab</option>-->
<!--            <option value="Adoptive_TIL_Breast_ResponseGroups">Adoptive_TIL_Breast</option>-->
<!--            <option value="WiemDataCheck_15C_check-ResponseGroupsDebug">WiemDataCheck_15C_Debug</option>-->
<!--            <option value="WiemDataCheck_15C_check-ResponseGroups">WiemDataCheck_15C</option>-->
<!--            <option value="WiemDataCheck_18C_check-ResponseGroups">WiemDataCheck_18C</option>-->
<!--            <option value="WiemDataCheck_HNSCC_check-ResponseGroups-Merged18C">WiemData_HNSCC_merged18C</option>-->
<!--            <option value="WiemDataCheck_18C_check-ResponseGroups_cervical">WiemDataCheck_18C_cervical</option>-->
<!--            <option value="WiemDataCheck_18C_check-ResponseGroups_SCC">WiemDataCheck_18C_SCC</option>-->
<!--            <option value="TCGA-PAAD">TCGA-PAAD</option>-->
<!--            <option value="Mouse">Mouse</option>-->
<!--            <option value="Sheba">Sheba</option>-->
            <option value="-1">Please select one project</option>
        </select>
        <label for="ds_type" style="color:red">Trained On: </label>
        <select name="ds_type" id="ds_type">
            <option value="BRCAOnly" selected>BRCAOnly</option>
            <option value="PanCancer">PanCancer</option>
        </select>
        <label for="num_patches" style="color:red">NumPatches: </label>
        <select name="num_patches" id="num_patches">
            <option value="64" selected>64</option>
            <option value="128">128</option>
        </select>
        <label for="split_num" style="color:red">Split: </label>
        <select name="split_num" id="split_num">
            <option value="0" selected>0</option>
<!--            <option value="1">1</option>-->
<!--            <option value="2">2</option>-->
<!--            <option value="3">3</option>-->
<!--            <option value="4">4</option>-->
        </select>
        <label for="encoder_type" style="color:red">Encoder Type: </label>
        <select name="encoder_type" id="encoder_type">
            <option value="imagenet" selected>ImageNetPretrained</option>
<!--            <option value="patch_mtl">PatchMTL</option>-->
        </select>
        <label for="backbone_type" style="color:red">Backbone Type: </label>
        <select name="backbone_type" id="backbone_type">
            <option value="mobilenetv3" selected>MobileNetV3</option>
            <!--            <option value="patch_mtl">PatchMTL</option>-->
        </select>
        <label for="feature_type" style="color:red">Feature Type: </label>
        <select name="feature_type" id="feature_type">
            <option value="after_encoder" selected>after_encoder</option>
            <option value="before_attention">before_attention</option>
        </select>
        <label for="task_type" style="color:red">Task Type: </label>
        <select name="task_type" id="task_type">
<!--            <option value="CLS_HistoAnno" selected>CLS_HistoAnno</option>-->
<!--            <option value="IHC_HER2">IHC_HER2</option>-->
<!--            <option value="subtype">subtype</option>-->
            <option value="survival_groups">survival_groups</option>
<!--            <option value="TP53_cls">TP53_cls</option>-->
            <option value="response_groups">response_groups</option>
        </select>

        <label for="subset_type" style="color:red">subset: </label>
        <select name="subset_type" id="subset_type">
            <option value="test" selected>test</option>
        </select>

        <label for="cluster_type" style="color:red">subset: </label>
        <select name="cluster_type" id="cluster_type">
            <option value="density_log_2d_10" selected>UMAP_2D</option>
            <option value="density_log_3d_10">UMAP_3D</option>
            <option value="feature_kmeans_10">Kmeans</option>
        </select>

        <button id="button_show_clusters" onclick="show_clusters()">Show Clusters</button>
        <button id="button_show_cluster_fractions" onclick="show_cluster_fractions2()">Show Cluster Fractions</button>
        <button id="button_show_tb_vis" onclick="button_show_tb_vis()">Show Tensorboard</button>
        <button id="button_show_umap3dvis" onclick="show_umap3dvis()">Show UMAP3D</button>
    </div>


    <div style="border: 3px solid black;padding: 2px; background-color: Ivory">

        <div>
            <label style="color:blue"><b>Group 1</b></label>
            <label for="category1">Choose a category:</label>
            <select name="category1" id="category1">
                <option value="-1" selected></option>
                <option value="0">Lobular</option>
                <option value="1">Ductal</option>
                <option value="2">Other</option>
            </select>
            <label for="slides">Choose a slide:</label>
            <select name="slides" id="slides">
            </select>
            <button id="button_load" onclick="show_image()">Show Image</button>
            <button id="button_show_patches" onclick="show_patches()">Show Patches</button>
            <button id="button_clear_patches" onclick="clear_patches()">Clear Patches</button>
            <!--            <button id="button_show_top_patches" onclick="show_top_patches()">Show Top Patches</button>-->
            <!--            <button id="button_clear_top_patches" onclick="clear_patches()">Clear Top Patches</button>-->
        </div>
        <br/>

<!--        <div>-->
<!--            <table>-->
<!--                <tr>-->
<!--                    <td><label>group-level fractions: </label></td>-->
<!--                    <td>-->
<!--                        <div id="legend1" style="border: 1px solid black; padding: 2px;"></div>-->
<!--                    </td>-->
<!--                </tr>-->
<!--            </table>-->
<!--        </div>-->
<!--        <br/>-->
        <table style="width:100%">
            <tr style="background-color: NavajoWhite">
                <td>image</td>
                <td>attention map</td>
                <td>selected patches in each cluster</td>
            </tr>
            <tr>
                <td style="width:25%">
                    <div id="viewer1" style="display: inline-block; height: 300px; width: 100%"></div>
                </td>
                <td style="width:25%">
                    <div id="viewer2" style="display: inline-block; height: 300px; width: 100%"></div>
                </td>
                <td style="width:50%">
                    <div id="viewer4" style="height: 300px; overflow:scroll;"></div>
                </td>
            </tr>
        </table>
    </div>
    <br/>

    <div style="border: 3px solid black;padding: 2px; background-color: AliceBlue">
        <div>
            <label style="color:blue"><b>Group 2</b></label>
            <label for="category2">Choose a category:</label>
            <select name="category2" id="category2">
                <option value="-1" selected></option>
                <option value="0">Lobular</option>
                <option value="1">Ductal</option>
                <option value="2">Other</option>
            </select>
            <label for="slides1">Choose a slide:</label>
            <select name="slides1" id="slides1">
            </select>
            <button id="button_load1" onclick="show_image1()">Show Image</button>
            <button id="button_show_patches1" onclick="show_patches1()">Show Patches</button>
            <button id="button_clear_patches1" onclick="clear_patches1()">Clear Patches</button>
            <!--            <button id="button_show_top_patches1" onclick="show_top_patches1()">Show Top Patches</button>-->
            <!--            <button id="button_clear_top_patches1" onclick="clear_patches1()">Clear Top Patches</button>-->
        </div>
        <br/>
<!--        <div>-->
<!--            <table>-->
<!--                <tr>-->
<!--                    <td><label>group-level fractions: </label></td>-->
<!--                    <td>-->
<!--                        <div id="legend2" style="border: 1px solid black; padding: 2px;"></div>-->
<!--                    </td>-->
<!--                </tr>-->
<!--            </table>-->
<!--        </div>-->
<!--        <br/>-->
        <table style="width:100%">
            <tr style="background-color: NavajoWhite">
                <td>image</td>
                <td>attention map</td>
                <td>selected patches in each cluster</td>
            </tr>
            <tr>
                <td style="width:25%">
                    <div id="viewer11" style="display: inline-block; height: 300px; width: 100%"></div>
                </td>
                <td style="width:25%">
                    <div id="viewer21" style="display: inline-block; height: 300px; width: 100%"></div>
                </td>
                <td style="width:50%">
                    <div id="viewer41" style="height: 300px; overflow:scroll;"></div>
                </td>
            </tr>
        </table>
    </div>
</div>

<script type="text/javascript">

    var formatter = function (annotation) {
        var c = parseInt(annotation.id.split('-')[1]);
        return {
            'style': `stroke-width:2; stroke: ${CSS_COLOR_NAMES[c]}`
        }
    }

    var viewer1, viewer2, viewer3;
    var viewer11, viewer21, viewer31;
    var anno1, anno11;

    window.onload = function () {
        viewer1 = OpenSeadragon({
            id: "viewer1",
            prefixUrl: "openseadragon/build/openseadragon/images/",
            // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_orig.dzi",
            showNavigator: true,
        });
        anno1 = OpenSeadragon.Annotorious(viewer1, {
            locale: 'auto',
            drawOnSingleClick: false,
            allowEmpty: false,
            // formatter: formatter
            formatters: [formatter, Annotorious.ShapeLabelsFormatter()]
            // disableEditor: true
        });


        viewer2 = OpenSeadragon({
            id: "viewer2",
            prefixUrl: "openseadragon/build/openseadragon/images/",
            // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_attention_map.dzi",
            showNavigator: true,
        });

        var viewer1Leading = false;
        var viewer2Leading = false;

        var viewer1Handler = function () {
            if (viewer2Leading) {
                return;
            }

            viewer1Leading = true;
            viewer2.viewport.zoomTo(viewer1.viewport.getZoom());
            viewer2.viewport.panTo(viewer1.viewport.getCenter());
            viewer1Leading = false;
        };

        var viewer2Handler = function () {
            if (viewer1Leading) {
                return;
            }

            viewer2Leading = true;
            viewer1.viewport.zoomTo(viewer2.viewport.getZoom());
            viewer1.viewport.panTo(viewer2.viewport.getCenter());
            viewer2Leading = false;
        };

        viewer1.addHandler('zoom', viewer1Handler);
        viewer2.addHandler('zoom', viewer2Handler);
        viewer1.addHandler('pan', viewer1Handler);
        viewer2.addHandler('pan', viewer2Handler);

        // viewer3 = OpenSeadragon({
        //     id: "viewer3",
        //     type: 'image',
        //     prefixUrl: "openseadragon/build/openseadragon/images/",
        //     // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_orig.dzi",
        //     showNavigator: true,
        // });


        viewer11 = OpenSeadragon({
            id: "viewer11",
            prefixUrl: "openseadragon/build/openseadragon/images/",
            // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_orig.dzi",
            showNavigator: true,
        });
        anno11 = OpenSeadragon.Annotorious(viewer11, {
            locale: 'auto',
            drawOnSingleClick: false,
            allowEmpty: false,
            // formatter: formatter
            formatters: [formatter, Annotorious.ShapeLabelsFormatter()]
            // disableEditor: true
        });


        viewer21 = OpenSeadragon({
            id: "viewer21",
            prefixUrl: "openseadragon/build/openseadragon/images/",
            // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_attention_map.dzi",
            showNavigator: true,
        });

        var viewer11Leading = false;
        var viewer21Leading = false;

        var viewer11Handler = function () {
            if (viewer21Leading) {
                return;
            }

            viewer11Leading = true;
            viewer21.viewport.zoomTo(viewer11.viewport.getZoom());
            viewer21.viewport.panTo(viewer11.viewport.getCenter());
            viewer11Leading = false;
        };

        var viewer21Handler = function () {
            if (viewer11Leading) {
                return;
            }

            viewer21Leading = true;
            viewer11.viewport.zoomTo(viewer21.viewport.getZoom());
            viewer11.viewport.panTo(viewer21.viewport.getCenter());
            viewer21Leading = false;
        };

        viewer11.addHandler('zoom', viewer11Handler);
        viewer21.addHandler('zoom', viewer21Handler);
        viewer11.addHandler('pan', viewer11Handler);
        viewer21.addHandler('pan', viewer21Handler);

        // viewer31 = OpenSeadragon({
        //     id: "viewer31",
        //     type: 'image',
        //     prefixUrl: "openseadragon/build/openseadragon/images/",
        //     // tileSources: "b/TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E_big_orig.dzi",
        //     showNavigator: true,
        // });
    }

    function get_results_path() {
        const project_type_element = document.getElementById("project_type")
        const project_type = project_type_element.options[project_type_element.selectedIndex].value;
        const ds_type_element = document.getElementById("ds_type")
        const ds_type = ds_type_element.options[ds_type_element.selectedIndex].value;
        const num_patches_element = document.getElementById("num_patches")
        const num_patches = num_patches_element.options[num_patches_element.selectedIndex].value;
        const split_num_element = document.getElementById("split_num")
        let split_num = split_num_element.options[split_num_element.selectedIndex].value;
        const encoder_type_element = document.getElementById("encoder_type")
        const encoder_type = encoder_type_element.options[encoder_type_element.selectedIndex].value;
        const backbone_type_element = document.getElementById("backbone_type")
        const backbone_type = backbone_type_element.options[backbone_type_element.selectedIndex].value;
        const feature_type_element = document.getElementById("feature_type")
        const feature_type = feature_type_element.options[feature_type_element.selectedIndex].value;
        const task_type_element = document.getElementById("task_type")
        const task_type = task_type_element.options[task_type_element.selectedIndex].value;
        const subset_type_element = document.getElementById("subset_type")
        const subset_type = subset_type_element.options[subset_type_element.selectedIndex].value;
        const cluster_type_element = document.getElementById("cluster_type")
        const cluster_type = cluster_type_element.options[cluster_type_element.selectedIndex].value;

        var postfix = "HF";
        split_num = 1;
        let epoch_num = 54;

        if (ds_type === "PanCancer") {
            postfix = "FP";
            split_num = 3;
            epoch_num = 22;
        }


        return `data/${project_type}/differential_results/${ds_type}2GPUs${postfix}/shared_attention_${encoder_type}${backbone_type}/split${split_num}_e49_h224_p${num_patches}_density_vis/${cluster_type}/${task_type}_top_64_clustering/feat_${feature_type}_feat/${subset_type}`;
    }
</script>
<!--<div>-->
<!--    <button id="button_change_color" onclick="change_color()">Change Color</button>-->
<!--</div>-->

<script type="text/javascript">

    colorize = function (legendname, colorList) {
        var container = document.getElementById(legendname);
        container.innerHTML = "";

        for (var key in colorList) {
            var boxContainer = document.createElement("DIV");
            boxContainer.style.cssText = "display: table-cell; vertical-align: center";
            var box = document.createElement("DIV");
            var label = document.createElement("SPAN");

            label.innerHTML = `${key}`;
            box.className = "box";
            box.style.backgroundColor = colorList[key];

            boxContainer.appendChild(box);
            boxContainer.appendChild(label);
            boxContainer.append(document.createTextNode(""));

            container.appendChild(boxContainer);

        }
    }

    function clear_patches_for_each_cluster(category_id, viewer_id, legend_id) {

        let container = document.getElementById(viewer_id);
        container.innerHTML = "";
        let table_str = '<table><tr><td></td><td>fraction<br>(group level)</td><td>fraction<br>(case level)</td><td>patches</td></tr>';
        for (let i = 0; i < group_cluster_fractions['cluster_name'].length; i++) {
            let cname = group_cluster_fractions['cluster_name'][i];
            table_str += `<tr><td><div style="background-color: ${CSS_COLOR_NAMES[i]}">${cname}</div></td>`;
            table_str += `<td><div id="${category_id}_${i}_group_level_frac"></div></td>`;
            table_str += `<td><div id="${category_id}_${i}_frac"></div></td>`;
            table_str += `<td><div id="${category_id}_${i}"></div></td></tr>`;
        }
        table_str += '</table>';
        container.innerHTML = table_str;
    }

    function clear_select_options(eid) {
        let e = document.getElementById(eid);
        let i, L = e.options.length - 1;
        for (i = L; i >= 0; i--) {
            e.remove(i);
        }
    }


    function add_option_to_select(eid) {

        let e = document.getElementById(eid);
        var option = document.createElement("option");
        option.text = "";
        option.value = -1;
        e.add(option, 0);
        for (let i = 0; i < category_names.length; i++) {
            option = document.createElement("option");
            option.text = category_names[i];
            option.value = category_names[i];
            e.add(option, i + 1);
        }
    }

    function clear_all_image_patches() {
        viewer1.close();
        viewer2.close();
        viewer11.close();
        viewer21.close();
        anno1.clearAnnotations();
        anno11.clearAnnotations();

        document.getElementById("category1").selectedIndex = -1;
        document.getElementById("category2").selectedIndex = -1;
        clear_select_options("category1");
        clear_select_options("category2");
        add_option_to_select('category1');
        add_option_to_select('category2');
        // document.getElementById("legend1").innerHTML = "";
        // document.getElementById("legend2").innerHTML = "";
        clear_select_options("slides");
        clear_select_options("slides1");
        slide1_name = "";
        slide2_name = "";
        results_path = "";
    }

    var allTextLines;
    var group_cluster_fractions = {};
    var category_names = [];
    var tb_dict = {}

    function load_group_cluster_fractions() {
        group_cluster_fractions = {};
        category_names = [];
        results_path = get_results_path();
        var filename = `${results_path}/cluster_counts_by_category_fraction.csv`;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                allText = xhttp.responseText;
                allTextLines = allText.split(/\r\n|\n/);
                console.log(allTextLines);
                // in here you basically manipulate your dom with fetched data or call on functions.

                console.log('group_cluster_fractions', group_cluster_fractions);
                for (let j = 0; j < allTextLines.length - 1; j++) {
                    const splits = allTextLines[j].split(',');
                    if (j === 0) {
                        group_cluster_fractions['cluster_name'] = splits.slice(1, splits.length);
                    } else {
                        group_cluster_fractions[splits[0]] = splits.slice(1, splits.length);
                        category_names.push(splits[0]);
                    }
                }

                clear_patches_for_each_cluster('category1', 'viewer4', 'legend1');
                clear_patches_for_each_cluster('category2', 'viewer41', 'legend2');
                clear_all_image_patches();
            } else {
                console.log(this.status);
            }
        };
        xhttp.open("GET", filename, true);
        xhttp.send();
    }

    load_group_cluster_fractions();

    var cluster_fractions_per_case = {};

    function load_fractions_per_case() {
        cluster_fractions_per_case = {};
        results_path = get_results_path();
        var filename = `${results_path}/cluster_counts_per_case.csv`;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                allText = xhttp.responseText;
                allTextLines = allText.split(/\r\n|\n/);
                console.log(allTextLines);
                // in here you basically manipulate your dom with fetched data or call on functions.

                console.log('cluster_fractions_per_case', cluster_fractions_per_case);
                for (let j = 1; j < allTextLines.length - 1; j++) {
                    const splits = allTextLines[j].split(',');
                    const splits2 = splits[1].split('/');
                    let svs_prefix = splits2[splits2.length - 1].replace('.svs', '');
                    cluster_fractions_per_case[svs_prefix] = splits.slice(4, splits.length);
                }

                clear_patches_for_each_cluster('category1', 'viewer4', 'legend1');
                clear_patches_for_each_cluster('category2', 'viewer41', 'legend2');
                clear_all_image_patches();
            } else {
                console.log(this.status);
            }
        };
        xhttp.open("GET", filename, true);
        xhttp.send();
    }

    load_fractions_per_case();

    function load_tb_dict() {
        tb_dict = {}
        var filename = 'tb_list.txt';
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                allText = xhttp.responseText;
                allTextLines = allText.split(/\r\n|\n/);
                console.log(allTextLines);

                for (let j = 0; j < allTextLines.length - 1; j++) {
                    const splits = allTextLines[j].split(',');
                    tb_dict[splits[0]] = splits[2];
                }
            } else {
                console.log(this.status);
            }
        }
        xhttp.open("GET", filename, true);
        xhttp.send();
    }

    load_tb_dict();

    function load_all_data() {
        results_path = get_results_path();
        load_group_cluster_fractions();
        load_fractions_per_case();
        load_umap3d_data();
        load_final_centroids_data();
    }

    var results_path = "";
    document.getElementById("ds_type").onchange = function () {
        load_all_data();
    };
        document.getElementById("num_patches").onchange = function () {
        load_all_data();
    };
    document.getElementById("split_num").onchange = function () {
        load_all_data();
    };
    document.getElementById("feature_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("project_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("encoder_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("backbone_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("task_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("subset_type").onchange = function () {
        load_all_data();
    };
    document.getElementById("cluster_type").onchange = function () {
        load_all_data();
    };

    var slide1_name = "";
    var slide2_name = "";
    var umap3dvis_window = null;
    document.getElementById("slides").addEventListener("change", (event) => {
        show_image();
        show_patches();
    });
    document.getElementById("slides1").addEventListener("change", (event) => {
        show_image1();
        show_patches1();
    });

    function show_clusters() {
        results_path = get_results_path();
        var task_type_e = document.getElementById('task_type');
        var subset_type_e = document.getElementById("subset_type");
        var feat_type_e = document.getElementById("feature_type");
        var task_type = task_type_e.options[task_type_e.selectedIndex].text;
        var subset_type = subset_type_e.options[subset_type_e.selectedIndex].text;
        var feat_type = feat_type_e.options[feat_type_e.selectedIndex].text;
        var url = `${results_path}/${task_type}_${subset_type}_feat_${feat_type}_feat_umap2d_kdeplot_no_category_with_centers.png`;
        img = '<img alt="" src="' + url + '" style="height: 100%; width: 100%; object-fit: contain">';
        popup = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=512px,height=512px');
        popup.document.write(img);

        // url = `${results_path}/${task_type}_${subset_type}_final_centroids.txt`;
        //
        // var xhttp = new XMLHttpRequest();
        // xhttp.onreadystatechange = function () {
        //     if (this.readyState === 4 && this.status === 200) {
        //         // Typical action to be performed when the document is ready:
        //         allText = xhttp.responseText;
        //         //csv = allText.split(/\r\n|\n/);
        //
        //         // // (A) GET HTML TABLE
        //         // let table = document.createElement("TABLE");
        //         // // (B1) REMOVE OLD TABLE ROWS
        //         // table.innerHTML = "";
        //         //
        //         // // (B2) GENERATE TABLE
        //         // for (let row of csv) {
        //         //     let tr = table.insertRow();
        //         //     for (let col of row.split(",")) {
        //         //         let td = tr.insertCell();
        //         //         td.innerHTML = col;
        //         //     }
        //         // }
        //         //
        //         // popup.document.write(table.innerHTML);
        //
        //         popup.document.write(allText);
        //     } else {
        //         console.log(this.status);
        //     }
        // };
        // xhttp.open("GET", url, true);
        // xhttp.send();

    }

    function show_cluster_fractions() {
        results_path = get_results_path();
        var url = `${results_path}/cluster_fractions_boxplot_by_category.png`;
        img = '<img alt="" src="' + url + '" style="height: 100%; width: 100%; object-fit: contain">';
        popup = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=512px,height=512px');
        popup.document.write(img);
    }

    function show_cluster_fractions2() {
        results_path = get_results_path();
        var task_type_e = document.getElementById('task_type');
        var task_type = task_type_e.options[task_type_e.selectedIndex].text;

        var c1 = document.getElementById('category1');
        var c2 = document.getElementById('category2');
        console.log(c1.selectedIndex)
        console.log(c2.selectedIndex)
        if (c1.options[c1.selectedIndex].text === "" || c2.options[c2.selectedIndex].text === "") {
            window.alert("Please select the two category in the following two panels.")
        } else {
            var c1_value = ALL_LABELS[task_type][c1.options[c1.selectedIndex].value];
            var c2_value = ALL_LABELS[task_type][c2.options[c2.selectedIndex].value];
            var url = `${results_path}/cluster_fractions_boxplot_between_${c1_value}_and_${c2_value}.png`;
            img = '<img alt="" src="' + url + '" style="height: 100%; width: 100%; object-fit: contain">';
            popup = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=512px,height=512px');
            popup.document.write(img);
        }
    }

    function button_show_tb_vis_bak() {
        results_path = get_results_path();
        console.log(results_path)
        // $.ajax({
        //     type: "POST",
        //     url: 'http://34.145.166.78:9000/showtb',
        //     //crossDomain: true,
        //     data: JSON.stringify({ 'path': results_path }),
        //     // contentType: "application/json",
        //     //dataType: "json",
        //     success: function (data) {
        //         console.log(data)
        //     }})
        // $.post('http://34.145.166.78:9000/showtb', {'path': results_path})
        //     .done(function( data ) {
        //         console.log( "Data Loaded: " + data );
        //     });
        //popup = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=512px,height=512px');
        //popup.document.write(img);

        let post = JSON.stringify({'path': results_path})
        const url = "http://34.145.166.78:9000/showtb"
        let xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                allText = xhr.responseText;
                console.log(allText)
            }
        }
        xhr.open('POST', url, true)
        xhr.setRequestHeader('Content-type', 'application/json; charset=UTF-8')
        xhr.send(post);
    }

    function button_show_tb_vis() {
        results_path = get_results_path();
        let key = './' + results_path + '/vis'
        console.log(key);
        window.open(tb_dict[key]);
    }


    function add_change_listener(category_id, select_id, legend_id, viewer_id) {

        let e = document.getElementById(category_id);
        let e2 = document.getElementById(select_id);

        e.addEventListener('change', (event) => {
            results_path = get_results_path();
            let category_value = e.options[e.selectedIndex].value;
            let category_name = e.options[e.selectedIndex].text;
            console.log(category_value);
            console.log(category_name);

            if (category_value === "-1") {
                return;
            }

            var i, L = e2.options.length - 1;
            for (i = L; i >= 0; i--) {
                e2.remove(i);
            }
            // var option = document.createElement("option");
            // option.text = "Kiwi";
            // option.value = "Kiwi";
            // e2.add(option, 0);
            var filename = `${results_path}/counts_in_for_label_${category_name}.csv`;
            console.log(filename);
            var Lines = [];
            // var txtFile = new XMLHttpRequest();
            // txtFile.open("GET", `http://localhost/~zhongz2/Frontend/HistoAnno_top_64_clustering/counts_in_for_label_${evalue}_${etext}.csv`, true);
            // console.log(txtFile.statusText);
            // txtFile.onreadystatechange = function()
            // {
            //     allText = txtFile.responseText;
            //     console.log(allText);
            //     allTextLines = allText.split(/\r\n|\n/);
            //     console.log(allTextLines);
            //     for (var j=1; j<allTextLines.length-1; j++) {
            //         var splits = allTextLines[j].split(',');
            //         var option = document.createElement("option");
            //         option.text = splits[1];
            //         option.value = splits[1];
            //         e2.add(option, j-1);
            //     }
            // };

            // fetch(filename)
            //     .then(res => res.text())
            //     .then(out => {
            //         console.log(out);
            //     }).catch(err => throw err);

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    // Typical action to be performed when the document is ready:
                    console.log(xhttp.responseText);
                    allText = xhttp.responseText;
                    console.log(allText);
                    allTextLines = allText.split(/\r\n|\n/);
                    console.log(allTextLines);
                    for (var j = 1; j < allTextLines.length - 1; j++) {
                        var splits = allTextLines[j].split(',');
                        var option = document.createElement("option");
                        option.text = splits[1];
                        option.value = splits[1];
                        e2.add(option, j - 1);
                    }

                    if (e2.options.length > 0) {
                        e2.options[0].selected = true;
                    }

                    const colorList = {};
                    for (let i = 0; i < group_cluster_fractions['cluster_name'].length; i++) {
                        colorList[`${group_cluster_fractions['cluster_name'][i]} (${group_cluster_fractions[category_name][i].substring(0, 5)})`]
                            = `${CSS_COLOR_NAMES[i]}`;
                    }
                    // colorize(legend_id, colorList);

                    clear_patches_for_each_cluster(category_id, viewer_id, legend_id);

                    if (category_id === 'category1') {
                        viewer1.close();
                        viewer2.close();
                        anno1.clearAnnotations();
                    } else {
                        viewer11.close();
                        viewer21.close();
                        anno11.clearAnnotations();
                    }

                    // in here you basically manipulate your dom with fetched data or call on functions.
                } else {
                    console.log(this.status);
                }
            };
            xhttp.open("GET", filename, true);
            xhttp.send();
            console.log('slides loaded');

            // const colorList = {};
            // for (i = 0; i < group_cluster_fractions['cluster_name'].length; i++) {
            //     colorList[`${group_cluster_fractions['cluster_name'][i]} (${group_cluster_fractions[category_name][i].substring(0, 5)})`]
            //         = `${CSS_COLOR_NAMES[i]}`;
            // }
            // colorize(legend_id, colorList);
            //
            //
            // let container = document.getElementById(viewer_id);
            // container.innerHTML = "";
            // // let table_str = '<table><tr><td></td><td>fraction</td><td>patches</td></tr>';
            // // for (i = 0; i < group_cluster_fractions['cluster_name'].length; i++) {
            // //     let cname = group_cluster_fractions['cluster_name'][i];
            // //     table_str += `<tr><td><div style="background-color: ${CSS_COLOR_NAMES[i]}">${cname}</div></td>`;
            // //     table_str += `<td><div id="${category_id}_${i}_frac"></div></td>`;
            // //     table_str += `<td><div id="${category_id}_${i}"></div></td></tr>`;
            // // }
            // // table_str += '</table>';
            // // container.innerHTML = table_str;
            // clear_patches_for_each_cluster(category_id, viewer_id);
        });
    }

    add_change_listener("category1", "slides", "legend1", "viewer4");
    add_change_listener("category2", "slides1", "legend2", "viewer41");

    function show_patches_new(category_id, select_id, viewer, anno) {

        results_path = get_results_path();
        const e = document.getElementById(select_id);
        const slide_name = e.options[e.selectedIndex].text;
        const ee = document.getElementById(category_id);
        let category_name = ee.options[ee.selectedIndex].text;

        for (let i = 0; i < group_cluster_fractions['cluster_name'].length; i++) {
            let cname = group_cluster_fractions['cluster_name'][i];
            let group_level_frac = group_cluster_fractions[category_name][i].substring(0, 5);
            const filename = `${results_path}/selected_patches/${slide_name}/${cname}.txt`;
            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    // Typical action to be performed when the document is ready:
                    allText = xhttp.responseText;
                    allTextLines = allText.split(/\r\n|\n/);

                    let patch_filenames = [];
                    let xs = [];
                    let ys = [];
                    let umap3dxs = [];
                    let umap3dys = [];
                    let umap3dzs = [];
                    for (let j = 0; j < allTextLines.length - 1; j++) {
                        let junk = allTextLines[j].split(',');
                        xs.push(junk[0]);
                        ys.push(junk[1]);
                        patch_filenames.push(`${results_path}/selected_patches/${slide_name}/${cname}/${junk[2]}`);
                        umap3dxs.push(junk[4]);
                        umap3dys.push(junk[5]);
                        umap3dzs.push(junk[6]);
                    }
                    let frac = parseInt(cluster_fractions_per_case[slide_name][i]) / 64.;
                    document.getElementById(`${category_id}_${i}_group_level_frac`).innerHTML = "";
                    document.getElementById(`${category_id}_${i}_group_level_frac`).innerText = `${group_level_frac}`;
                    document.getElementById(`${category_id}_${i}_frac`).innerHTML = "";
                    document.getElementById(`${category_id}_${i}_frac`).innerText = `${frac}`;

                    document.getElementById(`${category_id}_${i}`).innerHTML = "";
                    if (patch_filenames.length > 0) {

                        var boxContainer = document.createElement("DIV");
                        boxContainer.style.cssText = "width: 100%; height: 64px; float: left; overflow: auto";
                        console.log(cname, patch_filenames);
                        for (let k = 0; k < patch_filenames.length; k++) {

                            //let div1 = document.createElement("DIV");
                            //div1.className = "patchzoom"
                            let img1 = document.createElement("IMG");
                            img1.className = "img1";
                            img1.alt = "";
                            img1.src = `${patch_filenames[k]}`;

                            img1.addEventListener("click", (event) => {
                                const junk = img1.src.split('/')
                                const annoid = junk[junk.length - 1].replace('.jpg', '');
                                console.log(`annoid=${annoid},(${xs[k]}, ${ys[k]})`);
                                console.log(viewer.viewport.getZoom());
                                console.log(viewer.viewport.getCenter());

                                let viewport_coord = viewer.viewport.imageToViewportCoordinates(parseInt(xs[k]), parseInt(ys[k]));
                                console.log(viewport_coord);
                                viewer.viewport.panTo(viewport_coord);

                                if (event.button === 2) {
                                    console.log("mouse-right clicked")
                                }

                                if (umap3dvis_window !== null) {
                                    console.log('umap3dvis windows will be in ', umap3dxs[k], umap3dys[k], umap3dzs[k]);
                                    umap3dvis_window.postMessage(img1.src+','+umap3dxs[k]+','+umap3dys[k]+','+umap3dzs[k],
                                    "*");
                                } else {
                                    console.log('umap3dvis windows is missing. ', umap3dxs[k], umap3dys[k], umap3dzs[k]);
                                }
                            });
                            //div1.appendChild(img1)
                            boxContainer.appendChild(img1);
                        }
                        document.getElementById(`${category_id}_${i}`).appendChild(boxContainer);
                    } else {
                        //document.getElementById(`${category_id}_${i}`).innerText = "No patches";
                    }

                }
            };
            xhttp.open("GET", filename, true);
            xhttp.send();
            console.log('patch_filenames loaded');
        }
    }

    function show_image() {
        results_path = get_results_path();
        var e = document.getElementById("slides");
        var value = e.value;
        slide1_name = e.options[e.selectedIndex].text;
        viewer1.open(`${results_path}/big_images/${slide1_name}_big_orig.dzi`);
        viewer2.open(`${results_path}/big_images/${slide1_name}_big_attention_map.dzi`);
        anno1.clearAnnotations();
    }

    function show_image1() {
        results_path = get_results_path();
        var e = document.getElementById("slides1");
        var value = e.value;
        slide2_name = e.options[e.selectedIndex].text;
        viewer11.open(`${results_path}/big_images/${slide2_name}_big_orig.dzi`);
        viewer21.open(`${results_path}/big_images/${slide2_name}_big_attention_map.dzi`);
        anno11.clearAnnotations();
    }

    function show_patches() {

        results_path = get_results_path();
        var e = document.getElementById("slides");
        var slide_name = e.options[e.selectedIndex].text;
        anno1.clearAnnotations();
        anno1.loadAnnotations(`${results_path}/big_images/${slide_name}_patches_annotations.json`);

        show_patches_new('category1', 'slides', viewer1, anno1);
    }

    function show_patches1() {

        results_path = get_results_path();
        var e = document.getElementById("slides1");
        var slide_name = e.options[e.selectedIndex].text;
        anno11.clearAnnotations();
        anno11.loadAnnotations(`${results_path}/big_images/${slide_name}_patches_annotations.json`);

        show_patches_new('category2', 'slides1', viewer11, anno11);
    }

    function clear_patches() {
        anno1.clearAnnotations();
        //viewer3.close();
        clear_patches_for_each_cluster('category1', 'viewer4', 'legend1')
    }

    function clear_patches1() {
        anno11.clearAnnotations();
        //viewer31.close();
        clear_patches_for_each_cluster('category2', 'viewer41', 'legend2');
    }


    function openTabs(id_name) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(id_name).style.display = "block";
        event.currentTarget.className += " active";
    }

    var umap3d_data = {};
    var final_centroids_data = {};
    var x_min = Infinity, x_max = -Infinity;
    var y_min = Infinity, y_max = -Infinity;
    var z_min = Infinity, z_max = -Infinity;
    var center_x, center_y, center_z;
    function show_umap3dvis() {
        results_path = get_results_path();
        umap3dvis_window = window.open(`umap3dvis.html?ver=456`);
    }

    function load_umap3d_data() {
        x_min = Infinity; x_max = -Infinity;
        y_min = Infinity; y_max = -Infinity;
        z_min = Infinity; z_max = -Infinity;
        results_path = get_results_path();
        var filename = `${results_path}/all_data_for_umap3dvis.txt`;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                var allText = xhttp.responseText;
                umap3d_data = allText.split(/\r\n|\n/);
                // in here you basically manipulate your dom with fetched data or call on functions.

                for (let j = 0; j < umap3d_data.length - 1; j++) {
                    let splits = umap3d_data[j].split(',');
                    let x = parseFloat(splits[1]);
                    let y = parseFloat(splits[2]);
                    let z = parseFloat(splits[3]);
                    x_min = Math.min(x_min, x)
                    x_max = Math.max(x_max, x);
                    y_min = Math.min(y_min, y)
                    y_max = Math.max(y_max, y);
                    z_min = Math.min(z_min, z)
                    z_max = Math.max(z_max, z);
                }

                console.log(`x limit is ${x_min}, ${x_max}`);
                console.log(`y limit is ${y_min}, ${y_max}`);
                console.log(`z limit is ${z_min}, ${z_max}`);
                center_x = (x_max + x_min)/2;
                center_y = (y_max + y_min)/2;
                center_z = (z_max + z_min)/2;

            } else {
                console.log(this.status);
            }
        };
        xhttp.open("GET", filename, true);
        xhttp.send();
    }
    load_umap3d_data();

    function load_final_centroids_data() {
        results_path = get_results_path();
        let e = document.getElementById("task_type");
        let task_type = e.options[e.selectedIndex].text;
        e = document.getElementById("subset_type");
        let subset_type = e.options[e.selectedIndex].text;
        let filename = `${results_path}/${task_type}_${subset_type}_final_centroids.txt`;
        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                var allText = xhttp2.responseText;
                final_centroids_data = allText.split(/\r\n|\n/);
            }
        }
        xhttp2.open("GET", filename, true);
        xhttp2.send();
    }
    load_final_centroids_data();


    function load_projects() {
        let e = document.getElementById('project_type');
        let i, L = e.options.length - 1;
        for (i = L; i >= 0; i--) {
            e.remove(i);
        }

        var filename = `data/projects.txt`;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                // Typical action to be performed when the document is ready:
                let allText = xhttp.responseText;
                let allTextLines = allText.split(/\r\n|\n/);
                console.log(allTextLines);
                // in here you basically manipulate your dom with fetched data or call on functions.

                var option = document.createElement("option");
                option.text = "Please select one project";
                option.value = -1;
                option.disabled = true;
                option.selected = true;
                e.add(option, 0);
                for (let i = 0; i < allTextLines.length - 1; i++) {
                    option = document.createElement("option");
                    option.text = allTextLines[i];
                    option.value = allTextLines[i];
                    e.add(option, i + 1);
                }
            } else {
                console.log(this.status);
            }
        };
        xhttp.open("GET", filename, true);
        xhttp.send();
    }
    load_projects();

    // Called sometime after postMessage is called
    window.addEventListener("message", (event) => {
        console.log("yes, accept an message from ", event.origin);
    });
</script>
</body>
</html>